{% extends "base.html" %}

{% block title %}Checkout - Textile Store{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-credit-card me-2"></i>Checkout
            </h2>
        </div>
    </div>
    
    <div class="row">
        <!-- Order Summary -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-shopping-bag me-2"></i>Order Summary</h5>
                </div>
                <div class="card-body">
                    {% for item in cart_items %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="mb-0">{{ item[1] }}</h6>
                            <small class="text-muted">Qty: {{ item[3] }}</small>
                        </div>
                        <span class="fw-bold">₹{{ "%.2f"|format(item[2] * item[3]) }}</span>
                    </div>
                    <hr>
                    {% endfor %}
                    
                    <div class="d-flex justify-content-between">
                        <span class="h5">Total:</span>
                        <span class="h5 text-primary">₹{{ "%.2f"|format(total) }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Checkout Form -->
        <div class="col-md-8">
            <form method="POST" action="{{ url_for('process_payment') }}">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-shipping-fast me-2"></i>Shipping Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="shipping_address" class="form-label">Shipping Address</label>
                            <textarea class="form-control" id="shipping_address" name="shipping_address" 
                                      rows="3" required placeholder="Enter your complete address"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone_number" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                   required placeholder="Enter your phone number">
                        </div>
                    </div>
                </div>
                
                <!-- Payment Methods -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-credit-card me-2"></i>Payment Method</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- GPay -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="gpay" value="GPay" required>
                                    <label class="form-check-label" for="gpay">
                                        <i class="fab fa-google-pay text-primary me-2"></i>
                                        <strong>Google Pay</strong>
                                        <br><small class="text-muted">Pay with Google Pay</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- PhonePe -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="phonepe" value="PhonePe" required>
                                    <label class="form-check-label" for="phonepe">
                                        <i class="fas fa-mobile-alt text-info me-2"></i>
                                        <strong>PhonePe</strong>
                                        <br><small class="text-muted">Pay with PhonePe</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Paytm -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="paytm" value="Paytm" required>
                                    <label class="form-check-label" for="paytm">
                                        <i class="fas fa-wallet text-warning me-2"></i>
                                        <strong>Paytm</strong>
                                        <br><small class="text-muted">Pay with Paytm Wallet</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- UPI -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="upi" value="UPI" required>
                                    <label class="form-check-label" for="upi">
                                        <i class="fas fa-qrcode text-success me-2"></i>
                                        <strong>UPI</strong>
                                        <br><small class="text-muted">Pay with any UPI app</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Credit/Debit Card -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="card" value="Card" required>
                                    <label class="form-check-label" for="card">
                                        <i class="fas fa-credit-card text-dark me-2"></i>
                                        <strong>Credit/Debit Card</strong>
                                        <br><small class="text-muted">Visa, Mastercard, RuPay</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Net Banking -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="netbanking" value="Net Banking" required>
                                    <label class="form-check-label" for="netbanking">
                                        <i class="fas fa-university text-primary me-2"></i>
                                        <strong>Net Banking</strong>
                                        <br><small class="text-muted">Pay with your bank</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Cash on Delivery -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="cod" value="Cash on Delivery" required>
                                    <label class="form-check-label" for="cod">
                                        <i class="fas fa-money-bill-wave text-success me-2"></i>
                                        <strong>Cash on Delivery</strong>
                                        <br><small class="text-muted">Pay when delivered</small>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- EMI -->
                            <div class="col-md-6 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" 
                                           id="emi" value="EMI" required>
                                    <label class="form-check-label" for="emi">
                                        <i class="fas fa-calendar-alt text-info me-2"></i>
                                        <strong>EMI</strong>
                                        <br><small class="text-muted">Pay in installments</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Terms and Conditions -->
                <div class="card mt-4">
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Place Order Button -->
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-lock me-2"></i>Place Order - ₹{{ "%.2f"|format(total) }}
                    </button>
                    <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Cart
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Payment Terms:</h6>
                <ul>
                    <li>All payments are processed securely</li>
                    <li>Digital payments (GPay, PhonePe, UPI, Cards) are processed immediately</li>
                    <li>Cash on Delivery orders require payment upon delivery</li>
                    <li>EMI options are subject to bank approval</li>
                </ul>
                
                <h6>Shipping Terms:</h6>
                <ul>
                    <li>Free shipping on all orders</li>
                    <li>Delivery within 3-5 business days</li>
                    <li>Orders are processed within 24 hours</li>
                </ul>
                
                <h6>Return Policy:</h6>
                <ul>
                    <li>7-day return policy for unused items</li>
                    <li>Original packaging required for returns</li>
                    <li>Refunds processed within 5-7 business days</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Mock Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-shield-alt me-2"></i>Secure Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="payment-method-display" class="mb-3"></div>
                <div id="payment-amount" class="h3 text-success mb-3"></div>
                <div id="payment-status" class="mb-3">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <p class="mt-2">Processing your payment...</p>
                    <small class="text-muted">Please wait, do not close this window</small>
                </div>
                <div id="payment-success" class="d-none">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 text-success">Payment Successful!</h4>
                    <p>Your order is being confirmed...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Payment method selection effects
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        document.querySelectorAll('.form-check').forEach(option => {
            option.classList.remove('border-primary', 'bg-light');
        });
        if (this.checked) {
            this.closest('.form-check').classList.add('border-primary', 'bg-light');
        }
    });
});

// Online payment methods that require mock payment gateway
const onlinePaymentMethods = ['GPay', 'PhonePe', 'Paytm', 'UPI', 'Card', 'Net Banking', 'EMI'];

// Form submission handler
document.querySelector('form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked');
    const terms = document.getElementById('terms');
    const shippingAddress = document.getElementById('shipping_address').value;
    const phoneNumber = document.getElementById('phone_number').value;
    
    // Validation
    if (!paymentMethod) {
        alert('Please select a payment method');
        return;
    }
    
    if (!terms.checked) {
        alert('Please agree to the Terms and Conditions');
        return;
    }
    
    if (!shippingAddress || !phoneNumber) {
        alert('Please fill in all required fields');
        return;
    }
    
    const selectedPaymentMethod = paymentMethod.value;
    
    // Check if online payment or COD
    if (selectedPaymentMethod === 'Cash on Delivery') {
        // Direct form submission for COD
        this.submit();
    } else {
        // Process online payment through mock gateway
        processMockPayment(selectedPaymentMethod);
    }
});

function processMockPayment(paymentMethod) {
    const totalAmount = {{ total }};
    
    // Show payment modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
    
    // Display payment method icon
    const paymentDisplay = document.getElementById('payment-method-display');
    let icon = '';
    switch(paymentMethod) {
        case 'GPay':
            icon = '<i class="fab fa-google-pay fa-3x text-primary"></i><p class="mt-2">Google Pay</p>';
            break;
        case 'PhonePe':
            icon = '<i class="fas fa-mobile-alt fa-3x text-info"></i><p class="mt-2">PhonePe</p>';
            break;
        case 'Paytm':
            icon = '<i class="fas fa-wallet fa-3x text-warning"></i><p class="mt-2">Paytm</p>';
            break;
        case 'UPI':
            icon = '<i class="fas fa-qrcode fa-3x text-success"></i><p class="mt-2">UPI Payment</p>';
            break;
        case 'Card':
            icon = '<i class="fas fa-credit-card fa-3x text-dark"></i><p class="mt-2">Card Payment</p>';
            break;
        case 'Net Banking':
            icon = '<i class="fas fa-university fa-3x text-primary"></i><p class="mt-2">Net Banking</p>';
            break;
        case 'EMI':
            icon = '<i class="fas fa-calendar-alt fa-3x text-info"></i><p class="mt-2">EMI Payment</p>';
            break;
    }
    paymentDisplay.innerHTML = icon;
    document.getElementById('payment-amount').innerHTML = '₹' + totalAmount.toFixed(2);
    
    // Create mock payment order
    fetch('{{ url_for("create_mock_payment") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            amount: totalAmount,
            payment_method: paymentMethod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Simulate payment processing (2 seconds)
            setTimeout(() => {
                simulatePaymentCompletion(data.order_id, paymentMethod);
            }, 2000);
        } else {
            alert('Error creating payment order');
            modal.hide();
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        modal.hide();
    });
}

function simulatePaymentCompletion(orderId, paymentMethod) {
    // Simulate payment processing
    fetch('{{ url_for("simulate_payment") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            payment_method: paymentMethod,
            success: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success state
            document.getElementById('payment-status').classList.add('d-none');
            document.getElementById('payment-success').classList.remove('d-none');
            
            // Wait 1.5 seconds then submit form
            setTimeout(() => {
                const form = document.querySelector('form');
                
                // Add hidden fields for payment details
                const paymentIdInput = document.createElement('input');
                paymentIdInput.type = 'hidden';
                paymentIdInput.name = 'mock_payment_id';
                paymentIdInput.value = data.payment_id;
                form.appendChild(paymentIdInput);
                
                const orderIdInput = document.createElement('input');
                orderIdInput.type = 'hidden';
                orderIdInput.name = 'mock_order_id';
                orderIdInput.value = data.order_id;
                form.appendChild(orderIdInput);
                
                // Submit the form
                form.submit();
            }, 1500);
        } else {
            alert('Payment failed! Please try again.');
            location.reload();
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        location.reload();
    });
}
</script>
{% endblock %}



